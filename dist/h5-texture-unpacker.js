#!/usr/bin/env node

var e=require("sharp"),i=require("path"),t=require("fs"),r=require("yargs"),n=require("winston"),o=(new Date).toISOString(),a=n.format.printf((function(e){return o+"-"+e.level+": "+JSON.stringify(e.message,null,4)+"\n"})),s=n.createLogger({transports:[new n.transports.Console({format:n.format.combine(n.format.colorize(),a)})]}),l=(i.join(__dirname,"../"),r.usage("Usage: $0 -j [jsonFile] -o [outputDir]").option("imageFile",{alias:"i",demandOption:!1,default:"",describe:"The input texture image",type:"string"}).option("jsonFile",{alias:"j",demandOption:!0,describe:"The input JSON configuration",type:"string"}).option("outputDir",{alias:"o",demandOption:!0,describe:"The output folder",type:"string"}).option("verbose",{alias:"v",default:!1,describe:"Show log messages",type:"boolean"}).help("h").alias("h","help").epilog("copyright Azerion 2019").argv),f=i.join(l.i),p=i.join(l.j),m=i.join(l.o,"/"),u=JSON.parse(t.readFileSync(p));s.level=!0===l.verbose?"info":"warn",""===l.i&&(f=i.join(i.parse(p).dir,u.meta.image)),t.existsSync(f)||(s.error("Could not find image at specified path!"),process.exit(1)),t.existsSync(m)||t.mkdirSync(m),u.frames.forEach((function(t){0!==t.frame.w&&0!==t.frame.h?e(f).extract({width:t.frame.w,height:t.frame.h,left:t.frame.x,top:t.frame.y}).toFile(i.join(m,"/",t.filename+".png")).then((function(e){s.info("File: "+t.filename+" written")})).catch((function(e){s.info("Unable to write file , "+t.filename+":, "+e)})):s.warn("Unable to write file , "+t.filename+": Source width/height is 0")}));
