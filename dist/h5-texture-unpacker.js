#!/usr/bin/env node

var e=new(require("xml2js").Parser);var r=require("sharp"),a=require("path"),n=require("fs"),i=require("yargs"),o=require("winston"),t=(new Date).toISOString(),s=o.format.printf((function(e){return t+"-"+e.level+": "+JSON.stringify(e.message,null,4)+"\n"})),l=o.createLogger({transports:[new o.transports.Console({format:o.format.combine(o.format.colorize(),s)})]});a.join(__dirname,"../");var f,m,u,p=i.usage("Usage: $0 -j [jsonFile] -o [outputDir]").option("imageFile",{alias:"i",demandOption:!0,default:"",describe:"The input texture image",type:"string"}).option("atlasFile",{alias:"a",demandOption:!0,describe:"The input atlas",type:"string"}).option("outputDir",{alias:"o",demandOption:!0,describe:"The output folder",type:"string"}).option("verbose",{alias:"v",default:!1,describe:"Show log messages",type:"boolean"}).help("h").alias("h","help").epilog("copyright Azerion 2021").argv,c=a.join(p.i),h=a.join(p.a),y=a.join(p.o,"/"),g=n.readFileSync(h),w=null;l.level=!0===p.verbose?"info":"warn",n.existsSync(c)||(l.error("Could not find image at specified path!"),process.exit(1)),n.existsSync(y)||n.mkdirSync(y),h.match(/\.json$/)?(f=g,m=JSON.parse(f),u=[],null===(w=m.hasOwnProperty("frames")&&Array.isArray(m.frames)?(m.frames.forEach((function(e){u.push({name:e.filename,w:e.frame.w,h:e.frame.h,x:e.frame.x,y:e.frame.y})})),u):null)&&(w=function(e){var r=JSON.parse(e),a=[];return r.hasOwnProperty("frames")&&!Array.isArray(r.frames)?(Object.keys(r.frames).forEach((function(e){var n=r.frames[e];a.push({name:e,w:n.frame.w,h:n.frame.h,x:n.frame.x,y:n.frame.y})})),a):null}(g)),null===w&&(l.error("Could not get Hash nor Array data from json file: "+h),process.exit(1))):h.match(/\.xml$/)?w=function(r){e.parseString(r,(function(e,r){console.dir(r),console.log("Done")})),process.exit(0);var a=[];return null.hasOwnProperty("frames")&&Array.isArray(null.frames)?(null.frames.forEach((function(e){a.push({name:e.filename,w:e.frame.w,h:e.frame.h,x:e.frame.x,y:e.frame.y})})),a):null}(g):(l.error("Unknown file format: "+h),process.exit(1));var d=0;null==w||w.forEach((function(e){0!==e.w&&0!==e.h?r(c).extract({width:e.w,height:e.h,left:e.x,top:e.y}).toFile(a.join(y,"/",e.name+".png")).then((function(r){l.info("File: "+e.name+" written"),d++})).catch((function(r){l.info("Unable to write file , "+e.name+":, "+r)})):l.warn("Unable to write file , "+e.name+": Source width/height is 0")})),console.log("Done writing "+d+" images to "+y);
